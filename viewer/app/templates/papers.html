{% extends "base.html" %}

{% block title %}PaperFlow - Papers{% endblock %}

{% block head %}
<style>
  .card-enter { animation: cardIn 0.25s ease-out; }
  @keyframes cardIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .log-box { font-family: 'Courier New', monospace; font-size: 0.75rem; line-height: 1.4; }
  .log-box::-webkit-scrollbar { width: 4px; }
  .drop-active { border-color: #6366f1 !important; background: #eef2ff !important; }
</style>
{% endblock %}

{% block body %}
<div x-data="papersApp()" x-init="init()" class="min-h-full flex flex-col transition-colors">

  <!-- Navbar -->
  <nav class="sticky top-0 z-40 shadow-lg transition-colors"
       :class="$store.darkMode.on ? 'bg-gradient-to-r from-gray-800 via-gray-700 to-gray-800' : 'bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-500'">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-14">
        <div class="flex items-center space-x-3">
          <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
          </svg>
          <span class="text-white font-bold text-lg">PaperFlow</span>
        </div>
        <div class="flex items-center space-x-3">
          <span class="text-white/80 text-sm hidden sm:inline" x-text="'Hello, {{ username }}'"></span>
          <!-- Dark mode toggle -->
          <button @click="$store.darkMode.toggle()"
                  class="text-white/80 hover:text-white transition text-sm"
                  :title="$store.darkMode.on ? 'Light mode' : 'Dark mode'">
            <!-- Sun icon (light mode) -->
            <svg x-show="!$store.darkMode.on" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            <!-- Moon icon (dark mode) -->
            <svg x-show="$store.darkMode.on" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
            </svg>
          </button>
          <button @click="logout()" class="text-white/80 hover:text-white transition text-sm">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">

    <!-- Search bar -->
    <div class="mb-5">
      <div class="relative">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5" :class="$store.darkMode.on ? 'text-gray-500' : 'text-gray-400'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <input type="text" x-model="search" placeholder="Search papers..."
               class="w-full pl-10 pr-4 py-2.5 rounded-xl border shadow-sm text-sm focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 outline-none transition"
               :class="$store.darkMode.on ? 'bg-gray-800 border-gray-700 text-gray-100 placeholder-gray-500' : 'bg-white border-gray-200 text-gray-900 placeholder-gray-400'">
      </div>
    </div>

    <!-- Tabs + View toggle -->
    <div class="flex items-center justify-between mb-5">
      <div class="flex space-x-1 rounded-xl p-1 max-w-md transition-colors"
           :class="$store.darkMode.on ? 'bg-gray-800' : 'bg-gray-100'">
        <button @click="switchTab('unread')"
                :class="tab === 'unread'
                  ? ($store.darkMode.on ? 'bg-gray-700 shadow text-indigo-400 font-semibold' : 'bg-white shadow text-indigo-700 font-semibold')
                  : ($store.darkMode.on ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700')"
                class="flex-1 px-4 py-2 rounded-lg text-sm transition">
          Unread
          <span class="ml-1 text-xs rounded-full px-2 py-0.5"
                :class="tab === 'unread'
                  ? ($store.darkMode.on ? 'bg-indigo-900 text-indigo-300' : 'bg-indigo-100 text-indigo-600')
                  : ($store.darkMode.on ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-500')"
                x-text="stats.unread"></span>
        </button>
        <button @click="switchTab('archived')"
                :class="tab === 'archived'
                  ? ($store.darkMode.on ? 'bg-gray-700 shadow text-indigo-400 font-semibold' : 'bg-white shadow text-indigo-700 font-semibold')
                  : ($store.darkMode.on ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700')"
                class="flex-1 px-4 py-2 rounded-lg text-sm transition">
          Archived
          <span class="ml-1 text-xs rounded-full px-2 py-0.5"
                :class="tab === 'archived'
                  ? ($store.darkMode.on ? 'bg-indigo-900 text-indigo-300' : 'bg-indigo-100 text-indigo-600')
                  : ($store.darkMode.on ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-500')"
                x-text="stats.archived"></span>
        </button>
      </div>
      <!-- View mode toggle -->
      <div class="flex items-center space-x-1 rounded-lg p-1 transition-colors"
           :class="$store.darkMode.on ? 'bg-gray-800' : 'bg-gray-100'">
        <button @click="viewMode = 'card'; localStorage.setItem('pf-view', 'card')"
                class="p-1.5 rounded-md transition"
                :class="viewMode === 'card'
                  ? ($store.darkMode.on ? 'bg-gray-700 text-indigo-400' : 'bg-white text-indigo-600 shadow-sm')
                  : ($store.darkMode.on ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600')"
                title="Card view">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
            <rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/>
          </svg>
        </button>
        <button @click="viewMode = 'list'; localStorage.setItem('pf-view', 'list')"
                class="p-1.5 rounded-md transition"
                :class="viewMode === 'list'
                  ? ($store.darkMode.on ? 'bg-gray-700 text-indigo-400' : 'bg-white text-indigo-600 shadow-sm')
                  : ($store.darkMode.on ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600')"
                title="List view">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Upload panel (collapsible) -->
    <div class="mb-5" x-data="{ open: false }">
      <button @click="open = !open"
              class="flex items-center space-x-2 text-sm transition mb-2"
              :class="$store.darkMode.on ? 'text-gray-400 hover:text-indigo-400' : 'text-gray-500 hover:text-indigo-600'">
        <svg class="w-4 h-4 transition-transform" :class="open && 'rotate-90'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <span>Upload PDF</span>
      </button>
      <div x-show="open" x-collapse x-cloak>
        <div class="border-2 border-dashed rounded-xl p-6 text-center transition"
             :class="[
               dragOver ? ($store.darkMode.on ? 'border-indigo-400 bg-indigo-900/50' : 'border-indigo-500 bg-indigo-50') : ($store.darkMode.on ? 'border-gray-700 bg-gray-800' : 'border-gray-300 bg-white')
             ]"
             @dragover.prevent="dragOver = true"
             @dragleave.prevent="dragOver = false"
             @drop.prevent="handleDrop($event)"
             x-data="{ dragOver: false }">
          <svg class="mx-auto w-10 h-10 mb-2" :class="$store.darkMode.on ? 'text-gray-500' : 'text-gray-400'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
          </svg>
          <p class="text-sm mb-2" :class="$store.darkMode.on ? 'text-gray-400' : 'text-gray-500'">Drag & drop PDF here, or</p>
          <label class="inline-flex items-center px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-medium cursor-pointer hover:bg-indigo-700 transition">
            Browse files
            <input type="file" accept=".pdf" class="hidden" @change="handleFileSelect($event)">
          </label>
          <p x-show="uploading" class="mt-3 text-sm" :class="$store.darkMode.on ? 'text-indigo-400' : 'text-indigo-600'">
            <svg class="animate-spin inline -mt-0.5 mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
            </svg>
            Uploading...
          </p>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="flex justify-center py-12">
      <svg class="animate-spin h-8 w-8 text-indigo-500" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
      </svg>
    </div>

    <!-- Paper cards grid -->
    <div x-show="!loading && viewMode === 'card'" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <template x-for="paper in filtered" :key="paper.name">
        <div class="card-enter rounded-xl shadow-sm border transition-all overflow-hidden"
             :class="$store.darkMode.on ? 'bg-gray-800 border-gray-700 hover:shadow-lg hover:border-indigo-500' : 'bg-white border-gray-100 hover:shadow-md hover:border-indigo-200'">
          <a :href="'/viewer/' + encodeURIComponent(paper.name)" class="block p-4">
            <h3 class="font-semibold text-sm leading-snug mb-2 line-clamp-2 transition-colors"
                :class="$store.darkMode.on ? 'text-gray-100' : 'text-gray-900'"
                x-text="paper.name"></h3>
            <div class="flex flex-wrap gap-1.5 mb-2">
              <span x-show="paper.formats.html" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-700">HTML</span>
              <span x-show="paper.formats.md_ko" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-700">MD-KO</span>
              <span x-show="paper.formats.md_en" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">MD-EN</span>
              <span x-show="paper.formats.pdf" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">PDF</span>
            </div>
            <p class="text-xs transition-colors" :class="$store.darkMode.on ? 'text-gray-500' : 'text-gray-400'" x-text="paper.size_mb + ' MB'"></p>
          </a>
          <div class="border-t px-4 py-2 flex justify-end space-x-1 transition-colors"
               :class="$store.darkMode.on ? 'border-gray-700' : 'border-gray-50'">
            <button x-show="tab === 'unread'" @click.prevent="confirmAction('archive', paper)"
                    class="p-1.5 rounded-lg transition"
                    :class="$store.darkMode.on ? 'text-gray-500 hover:text-emerald-400 hover:bg-gray-700' : 'text-gray-400 hover:text-emerald-600 hover:bg-emerald-50'"
                    title="Archive">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </button>
            <button x-show="tab === 'archived'" @click.prevent="confirmAction('restore', paper)"
                    class="p-1.5 rounded-lg transition"
                    :class="$store.darkMode.on ? 'text-gray-500 hover:text-indigo-400 hover:bg-gray-700' : 'text-gray-400 hover:text-indigo-600 hover:bg-indigo-50'"
                    title="Restore">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
              </svg>
            </button>
            <button @click.prevent="confirmAction('delete', paper)"
                    class="p-1.5 rounded-lg transition"
                    :class="$store.darkMode.on ? 'text-gray-500 hover:text-red-400 hover:bg-gray-700' : 'text-gray-400 hover:text-red-600 hover:bg-red-50'"
                    title="Delete">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        </div>
      </template>
    </div>

    <!-- Paper list view -->
    <div x-show="!loading && viewMode === 'list'" class="space-y-1">
      <template x-for="paper in filtered" :key="paper.name">
        <div class="card-enter flex items-center rounded-lg border px-4 py-2.5 transition-all"
             :class="$store.darkMode.on ? 'bg-gray-800 border-gray-700 hover:border-indigo-500' : 'bg-white border-gray-100 hover:border-indigo-200'">
          <a :href="'/viewer/' + encodeURIComponent(paper.name)" class="flex-1 min-w-0 flex items-center gap-4">
            <h3 class="font-medium text-sm truncate transition-colors flex-1 min-w-0"
                :class="$store.darkMode.on ? 'text-gray-100' : 'text-gray-900'"
                x-text="paper.name"></h3>
            <div class="flex gap-1 shrink-0">
              <span x-show="paper.formats.html" class="px-1.5 py-0.5 rounded text-[10px] font-medium bg-emerald-100 text-emerald-700">HTML</span>
              <span x-show="paper.formats.md_ko" class="px-1.5 py-0.5 rounded text-[10px] font-medium bg-purple-100 text-purple-700">KO</span>
              <span x-show="paper.formats.md_en" class="px-1.5 py-0.5 rounded text-[10px] font-medium bg-gray-100 text-gray-600">EN</span>
              <span x-show="paper.formats.pdf" class="px-1.5 py-0.5 rounded text-[10px] font-medium bg-blue-100 text-blue-700">PDF</span>
            </div>
            <span class="text-xs w-14 text-right shrink-0 transition-colors"
                  :class="$store.darkMode.on ? 'text-gray-500' : 'text-gray-400'"
                  x-text="paper.size_mb + ' MB'"></span>
          </a>
          <div class="flex items-center space-x-1 ml-3 shrink-0">
            <button x-show="tab === 'unread'" @click.prevent="confirmAction('archive', paper)"
                    class="p-1 rounded transition"
                    :class="$store.darkMode.on ? 'text-gray-500 hover:text-emerald-400' : 'text-gray-400 hover:text-emerald-600'"
                    title="Archive">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </button>
            <button x-show="tab === 'archived'" @click.prevent="confirmAction('restore', paper)"
                    class="p-1 rounded transition"
                    :class="$store.darkMode.on ? 'text-gray-500 hover:text-indigo-400' : 'text-gray-400 hover:text-indigo-600'"
                    title="Restore">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
              </svg>
            </button>
            <button @click.prevent="confirmAction('delete', paper)"
                    class="p-1 rounded transition"
                    :class="$store.darkMode.on ? 'text-gray-500 hover:text-red-400' : 'text-gray-400 hover:text-red-600'"
                    title="Delete">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        </div>
      </template>
    </div>

    <!-- Empty state -->
    <div x-show="!loading && filtered.length === 0" class="text-center py-16">
      <svg class="mx-auto w-16 h-16 mb-4" :class="$store.darkMode.on ? 'text-gray-600' : 'text-gray-300'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
      <p class="text-sm" :class="$store.darkMode.on ? 'text-gray-500' : 'text-gray-400'" x-text="search ? 'No papers match your search.' : 'No papers yet. Upload a PDF to get started.'"></p>
    </div>

    <!-- Log viewer (collapsible with auto-refresh) -->
    <div class="mt-8">
      <button @click="toggleLog()"
              class="flex items-center space-x-2 text-sm transition mb-2"
              :class="$store.darkMode.on ? 'text-gray-400 hover:text-indigo-400' : 'text-gray-500 hover:text-indigo-600'">
        <svg class="w-4 h-4 transition-transform" :class="logOpen && 'rotate-90'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <span>Processing Log</span>
        <span x-show="logOpen" class="ml-1 w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
      </button>
      <div x-show="logOpen" x-collapse x-cloak>
        <div x-ref="logBox" class="bg-gray-900 rounded-xl p-4 max-h-80 overflow-y-auto log-box text-gray-300 whitespace-pre-wrap"
             x-text="logContent || 'Loading...'">
        </div>
      </div>
    </div>

  </main>

  <!-- Confirmation modal -->
  <div x-cloak x-show="modal.show" class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/40" @click="modal.show = false"></div>
    <div class="relative rounded-2xl shadow-xl max-w-sm w-full p-6 transition-colors"
         :class="$store.darkMode.on ? 'bg-gray-800' : 'bg-white'"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100">
      <h3 class="text-lg font-semibold mb-2" :class="$store.darkMode.on ? 'text-gray-100' : 'text-gray-900'" x-text="modal.title"></h3>
      <p class="text-sm mb-5" :class="$store.darkMode.on ? 'text-gray-400' : 'text-gray-500'" x-text="modal.message"></p>
      <div class="flex justify-end space-x-3">
        <button @click="modal.show = false"
                class="px-4 py-2 rounded-lg text-sm font-medium transition"
                :class="$store.darkMode.on ? 'text-gray-300 hover:bg-gray-700' : 'text-gray-600 hover:bg-gray-100'">
          Cancel
        </button>
        <button @click="executeAction()"
                :class="modal.action === 'delete' ? 'bg-red-600 hover:bg-red-700' : 'bg-indigo-600 hover:bg-indigo-700'"
                class="px-4 py-2 rounded-lg text-sm font-medium text-white transition">
          <span x-text="modal.action === 'delete' ? 'Delete' : modal.action === 'archive' ? 'Archive' : 'Restore'"></span>
        </button>
      </div>
    </div>
  </div>

</div>

<script>
function papersApp() {
  return {
    tab: 'unread',
    papers: [],
    search: '',
    loading: true,
    uploading: false,
    stats: { unread: 0, archived: 0 },
    logContent: '',
    logOpen: false,
    logInterval: null,
    viewMode: localStorage.getItem('pf-view') || 'card',
    modal: { show: false, action: '', paper: null, title: '', message: '' },

    async init() {
      await Promise.all([this.fetchPapers(), this.fetchStats()]);
    },

    get filtered() {
      if (!this.search) return this.papers;
      const q = this.search.toLowerCase();
      return this.papers.filter(p => p.name.toLowerCase().includes(q));
    },

    async switchTab(t) {
      this.tab = t;
      await this.fetchPapers();
    },

    async fetchPapers() {
      this.loading = true;
      try {
        const resp = await apiFetch('/api/papers?tab=' + this.tab);
        if (resp) this.papers = await resp.json();
      } catch (e) {
        showToast('Failed to load papers', 'error');
      } finally {
        this.loading = false;
      }
    },

    async fetchStats() {
      try {
        const resp = await apiFetch('/api/stats');
        if (resp) this.stats = await resp.json();
      } catch (e) { /* silent */ }
    },

    confirmAction(action, paper) {
      this.modal.action = action;
      this.modal.paper = paper;
      if (action === 'archive') {
        this.modal.title = 'Archive paper';
        this.modal.message = `Move "${paper.name}" to archived?`;
      } else if (action === 'restore') {
        this.modal.title = 'Restore paper';
        this.modal.message = `Move "${paper.name}" back to unread?`;
      } else {
        this.modal.title = 'Delete paper';
        this.modal.message = `Permanently delete "${paper.name}" (${paper.size_mb} MB)? This cannot be undone.`;
      }
      this.modal.show = true;
    },

    async executeAction() {
      const { action, paper } = this.modal;
      this.modal.show = false;
      const name = encodeURIComponent(paper.name);
      let resp;
      try {
        if (action === 'archive') {
          resp = await apiFetch(`/api/papers/${name}/archive`, { method: 'POST' });
        } else if (action === 'restore') {
          resp = await apiFetch(`/api/papers/${name}/restore`, { method: 'POST' });
        } else {
          resp = await apiFetch(`/api/papers/${name}`, { method: 'DELETE' });
        }
        if (resp && resp.ok) {
          const data = await resp.json();
          showToast(data.message);
          await Promise.all([this.fetchPapers(), this.fetchStats()]);
        } else if (resp) {
          const data = await resp.json().catch(() => ({}));
          showToast(data.detail || 'Action failed', 'error');
        }
      } catch (e) {
        showToast('Action failed', 'error');
      }
    },

    async handleDrop(event) {
      const files = event.dataTransfer.files;
      if (files.length > 0) await this.uploadFile(files[0]);
    },

    async handleFileSelect(event) {
      const files = event.target.files;
      if (files.length > 0) await this.uploadFile(files[0]);
      event.target.value = '';
    },

    async uploadFile(file) {
      if (!file.name.toLowerCase().endsWith('.pdf')) {
        showToast('Only PDF files are accepted', 'warning');
        return;
      }
      this.uploading = true;
      try {
        const form = new FormData();
        form.append('file', file);
        const resp = await fetch('/api/upload', {
          method: 'POST',
          credentials: 'same-origin',
          body: form,
        });
        if (resp.status === 401) { window.location.href = '/login'; return; }
        const data = await resp.json();
        if (resp.ok) {
          showToast(data.message);
        } else {
          showToast(data.detail || 'Upload failed', 'error');
        }
      } catch (e) {
        showToast('Upload failed', 'error');
      } finally {
        this.uploading = false;
      }
    },

    toggleLog() {
      this.logOpen = !this.logOpen;
      if (this.logOpen) {
        this.loadLog();
        this.logInterval = setInterval(() => this.loadLog(), 3000);
      } else {
        clearInterval(this.logInterval);
        this.logInterval = null;
      }
    },

    async loadLog() {
      try {
        const resp = await apiFetch('/api/logs/latest');
        if (resp) {
          const data = await resp.json();
          this.logContent = data.content || 'No logs found.';
          this.$nextTick(() => {
            const box = this.$refs.logBox;
            if (box) box.scrollTop = box.scrollHeight;
          });
        }
      } catch (e) {
        this.logContent = 'Failed to load logs.';
      }
    },

    async logout() {
      await apiFetch('/api/logout', { method: 'POST' });
      window.location.href = '/login';
    },
  };
}
</script>
{% endblock %}
