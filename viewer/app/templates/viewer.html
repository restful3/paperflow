{% extends "base.html" %}

{% block title %}{{ paper_name }} - PaperFlow{% endblock %}

{% block head %}
<style>
  .viewer-frame { height: calc(100vh - 3.5rem); }
</style>
{% endblock %}

{% block body %}
<div x-data="viewerApp()" class="h-full flex flex-col">

  <!-- Top bar -->
  <div class="h-14 shrink-0 bg-white border-b border-gray-200 flex items-center px-4 space-x-3 shadow-sm">
    <!-- Back -->
    <a href="/papers" class="p-1.5 rounded-lg text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 transition" title="Back to list">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    </a>

    <!-- Title -->
    <h1 class="flex-1 text-sm font-semibold text-gray-900 truncate">{{ paper_name }}</h1>

    <!-- View toggle -->
    <div class="flex bg-gray-100 rounded-lg p-0.5">
      <template x-if="hasHtml">
        <button @click="view = 'html'"
                :class="view === 'html' ? 'bg-white shadow text-indigo-700' : 'text-gray-500 hover:text-gray-700'"
                class="px-3 py-1 rounded-md text-xs font-medium transition">
          HTML
        </button>
      </template>
      <template x-if="hasPdf">
        <button @click="view = 'pdf'"
                :class="view === 'pdf' ? 'bg-white shadow text-indigo-700' : 'text-gray-500 hover:text-gray-700'"
                class="px-3 py-1 rounded-md text-xs font-medium transition">
          PDF
        </button>
      </template>
      <template x-if="hasHtml && hasPdf">
        <button @click="view = 'split'"
                :class="view === 'split' ? 'bg-white shadow text-indigo-700' : 'text-gray-500 hover:text-gray-700'"
                class="px-3 py-1 rounded-md text-xs font-medium transition">
          Split
        </button>
      </template>
    </div>

    <!-- Actions -->
    <template x-if="location === 'outputs'">
      <button @click="doAction('archive')"
              class="p-1.5 rounded-lg text-gray-400 hover:text-emerald-600 hover:bg-emerald-50 transition" title="Archive">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
      </button>
    </template>
    <template x-if="location === 'archives'">
      <button @click="doAction('restore')"
              class="p-1.5 rounded-lg text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 transition" title="Restore">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
        </svg>
      </button>
    </template>
    <button @click="doAction('delete')"
            class="p-1.5 rounded-lg text-gray-400 hover:text-red-600 hover:bg-red-50 transition" title="Delete">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
      </svg>
    </button>

    <!-- PDF Download -->
    <template x-if="hasPdf">
      <a :href="pdfUrl" download class="p-1.5 rounded-lg text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition" title="Download PDF">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
      </a>
    </template>
  </div>

  <!-- Content area -->
  <div class="flex-1 overflow-hidden flex">
    <!-- HTML view -->
    <template x-if="view === 'html'">
      <iframe :src="htmlUrl" class="w-full h-full border-0"></iframe>
    </template>

    <!-- PDF view -->
    <template x-if="view === 'pdf'">
      <iframe :src="pdfUrl" class="w-full h-full border-0"></iframe>
    </template>

    <!-- Split view -->
    <template x-if="view === 'split'">
      <div class="flex w-full h-full">
        <iframe :src="htmlUrl" class="h-full border-0 border-r border-gray-200" style="width: 50%"></iframe>
        <iframe :src="pdfUrl" class="h-full border-0" style="width: 50%"></iframe>
      </div>
    </template>

    <!-- No content -->
    <template x-if="!hasHtml && !hasPdf">
      <div class="flex-1 flex items-center justify-center text-gray-400 text-sm">
        No viewable files found for this paper.
      </div>
    </template>
  </div>

  <!-- Confirm modal -->
  <div x-cloak x-show="modal.show" class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/40" @click="modal.show = false"></div>
    <div class="relative bg-white rounded-2xl shadow-xl max-w-sm w-full p-6"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100">
      <h3 class="text-lg font-semibold text-gray-900 mb-2" x-text="modal.title"></h3>
      <p class="text-sm text-gray-500 mb-5" x-text="modal.message"></p>
      <div class="flex justify-end space-x-3">
        <button @click="modal.show = false"
                class="px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition">
          Cancel
        </button>
        <button @click="executeModalAction()"
                :class="modal.action === 'delete' ? 'bg-red-600 hover:bg-red-700' : 'bg-indigo-600 hover:bg-indigo-700'"
                class="px-4 py-2 rounded-lg text-sm font-medium text-white transition">
          Confirm
        </button>
      </div>
    </div>
  </div>

</div>

<script>
function viewerApp() {
  const name = '{{ paper_name_encoded }}';
  return {
    view: '{{ default_view }}',
    hasHtml: {{ 'true' if has_html else 'false' }},
    hasPdf: {{ 'true' if has_pdf else 'false' }},
    location: '{{ location }}',
    htmlUrl: '/api/papers/' + name + '/html',
    pdfUrl: '/api/papers/' + name + '/pdf',
    modal: { show: false, action: '', title: '', message: '' },

    doAction(action) {
      this.modal.action = action;
      const paperName = decodeURIComponent(name);
      if (action === 'archive') {
        this.modal.title = 'Archive paper';
        this.modal.message = `Move "${paperName}" to archived?`;
      } else if (action === 'restore') {
        this.modal.title = 'Restore paper';
        this.modal.message = `Move "${paperName}" back to unread?`;
      } else {
        this.modal.title = 'Delete paper';
        this.modal.message = `Permanently delete "${paperName}"? This cannot be undone.`;
      }
      this.modal.show = true;
    },

    async executeModalAction() {
      const action = this.modal.action;
      this.modal.show = false;
      let url, method;
      if (action === 'archive') { url = `/api/papers/${name}/archive`; method = 'POST'; }
      else if (action === 'restore') { url = `/api/papers/${name}/restore`; method = 'POST'; }
      else { url = `/api/papers/${name}`; method = 'DELETE'; }
      try {
        const resp = await apiFetch(url, { method });
        if (resp && resp.ok) {
          window.location.href = '/papers';
        } else if (resp) {
          const data = await resp.json().catch(() => ({}));
          showToast(data.detail || 'Action failed', 'error');
        }
      } catch (e) {
        showToast('Action failed', 'error');
      }
    },
  };
}
</script>
{% endblock %}
