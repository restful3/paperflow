services:
  paperflow-converter:
    build: .
    image: paperflow-converter:latest
    container_name: paperflow_converter
    command: ./run_batch_watch.sh
    runtime: nvidia
    volumes:
      - ./newones:/app/newones
      - ./outputs:/app/outputs
      - ./logs:/app/logs
      - ./config.json:/app/config.json
      - ./model_cache:/root/.cache/datalab/models
    env_file:
      - .env
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - OPENAI_BASE_URL=http://host.docker.internal:8317/v1
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    restart: unless-stopped
    # Use host networking or extra_hosts to verify connectivity if host.docker.internal fails on Linux
    extra_hosts:
      - "host.docker.internal:host-gateway"

  paperflow-viewer:
    build:
      context: ./viewer
      dockerfile: Dockerfile
    image: paperflow-viewer:latest
    container_name: paperflow_viewer
    ports:
      - "8090:8000"
    volumes:
      - ./outputs:/data/outputs
      - ./archives:/data/archives
      - ./newones:/data/newones
      - ./logs:/data/logs
    env_file:
      - .env
    environment:
      - BASE_DIR=/data
    restart: unless-stopped
